<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>VisionFace | Êô∫ËÉΩ‰∫∫ËÑ∏Ê£ÄÊµã</title>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a8a4e6;
            --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: var(--gradient-bg);
            padding: 2rem 1rem;
            color: #2d3436;
        }

        h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            letter-spacing: -0.5px;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(10px);
        }

        .control-section h2 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }

        #uploadForm {
            margin-bottom: 1rem;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        input[type="file"] {
            flex: 1;
            padding: 0.8rem 1.2rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="file"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
            outline: none;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover {
            background: #5b4bc4;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #webcamContainer {
            margin-top: 1rem;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        #webcamFeed {
            max-width: 100%;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #eee;
            min-height: 200px;
        }


        #imageContainer {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            background: white;
            max-width: 90%;
            margin-top: 1rem;
            display: none;
        }

        #uploadedImage, #imageCanvas {
            max-width: 600px;
            max-height: 600px;
            display: block;
            object-fit: contain;
            border-radius: 8px;
        }

        #imageCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .loader {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #captureCanvas {
            display: none;
        }
    </style>
</head>
<body>
<h1>VisionFace üë©‚Äçüíª</h1>

<div class="control-section">
    <h2>‰ªéÊñá‰ª∂‰∏ä‰º†</h2>
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="input-group">
            <input type="file" id="uploadFile" name="file" accept="image/*">
            <button type="submit">
                <span class="loader file-loader"></span>
                <span class="submit-text">‰∏ä‰º†Âπ∂Ê£ÄÊµã</span>
            </button>
        </div>
    </form>
</div>

<div class="control-section">
    <h2>‰ªéÊëÑÂÉèÂ§¥ÊçïËé∑</h2>
    <div class="input-group">
        <button id="startWebcam">ÂºÄÂêØÊëÑÂÉèÂ§¥</button>
        <button id="captureAndDetect" disabled>
            <span class="loader webcam-loader"></span>
            <span class="submit-text">ÊãçÁÖßÂπ∂Ê£ÄÊµã</span>
        </button>
        <button id="stopWebcam" disabled>ÂÅúÊ≠¢ÊëÑÂÉèÂ§¥</button>
    </div>
    <div id="webcamContainer">
        <video id="webcamFeed" autoplay playsinline></video>
    </div>
</div>

<div id="imageContainer">
    <img id="uploadedImage" src="#" alt="Â§ÑÁêÜÁöÑÂõæÁâá">
    <canvas id="imageCanvas"></canvas>
</div>

<canvas id="captureCanvas"></canvas>

<script>
    const uploadFile = document.getElementById('uploadFile');
    const uploadForm = document.getElementById('uploadForm');
    const fileLoader = document.querySelector('.file-loader');
    const fileSubmitText = uploadForm.querySelector('.submit-text');

    const startWebcamBtn = document.getElementById('startWebcam');
    const captureAndDetectBtn = document.getElementById('captureAndDetect');
    const stopWebcamBtn = document.getElementById('stopWebcam');
    const webcamLoader = document.querySelector('.webcam-loader');
    const webcamSubmitText = captureAndDetectBtn.querySelector('.submit-text');

    const webcamContainer = document.getElementById('webcamContainer');
    const webcamFeed = document.getElementById('webcamFeed');

    const imageContainer = document.getElementById('imageContainer');
    const uploadedImage = document.getElementById('uploadedImage');
    const imageCanvas = document.getElementById('imageCanvas');
    const imageCtx = imageCanvas.getContext('2d');

    const captureCanvas = document.getElementById('captureCanvas');
    const captureCtx = captureCanvas.getContext('2d');

    let stream = null;

    uploadFile.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage.src = e.target.result;
                uploadedImage.onload = function() {
                    setCanvasDimensions(this.naturalWidth, this.naturalHeight);
                    imageCtx.drawImage(this, 0, 0, imageCanvas.width, imageCanvas.height);
                    imageContainer.style.display = 'block';
                }
            }
            reader.readAsDataURL(file);
            stopWebcamStream();
        }
    });

    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!uploadFile.files.length) {
            alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂõæÁâáÊñá‰ª∂ÔºÅ');
            return;
        }
        stopWebcamStream();

        const formData = new FormData(this);
        performDetection(formData, fileLoader, fileSubmitText, '‰∏ä‰º†Âπ∂Ê£ÄÊµã');
    });

    startWebcamBtn.addEventListener('click', async () => {
        if (stream) return;

        startWebcamBtn.disabled = true;
        stopWebcamBtn.disabled = false;
        uploadFile.value = '';

        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            webcamFeed.srcObject = stream;
            webcamContainer.style.display = 'flex';
            webcamFeed.onloadedmetadata = () => {
                captureAndDetectBtn.disabled = false;
            };
            imageContainer.style.display = 'none';

        } catch (err) {
            console.error("ËÆøÈóÆÊëÑÂÉèÂ§¥Â§±Ë¥•:", err);
            alert(`Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥: ${err.name} - ${err.message}`);
            startWebcamBtn.disabled = false;
            stopWebcamBtn.disabled = true;
            captureAndDetectBtn.disabled = true;
        }
    });

    stopWebcamBtn.addEventListener('click', stopWebcamStream);

    function stopWebcamStream() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            webcamFeed.srcObject = null;
            webcamContainer.style.display = 'none';
            startWebcamBtn.disabled = false;
            stopWebcamBtn.disabled = true;
            captureAndDetectBtn.disabled = true;
            console.log("ÊëÑÂÉèÂ§¥Â∑≤ÂÅúÊ≠¢");
        }
    }

    captureAndDetectBtn.addEventListener('click', () => {
        if (!stream) {
            alert('ËØ∑ÂÖàÂºÄÂêØÊëÑÂÉèÂ§¥ÔºÅ');
            return;
        }

        const videoWidth = webcamFeed.videoWidth;
        const videoHeight = webcamFeed.videoHeight;
        captureCanvas.width = videoWidth;
        captureCanvas.height = videoHeight;
        captureCtx.drawImage(webcamFeed, 0, 0, videoWidth, videoHeight);

        uploadedImage.src = captureCanvas.toDataURL('image/jpeg');
        uploadedImage.onload = () => {
            setCanvasDimensions(videoWidth, videoHeight);
            imageCtx.drawImage(uploadedImage, 0, 0, imageCanvas.width, imageCanvas.height);
            imageContainer.style.display = 'block';
        };


        captureCanvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('file', blob, 'webcam_capture.jpg');
            performDetection(formData, webcamLoader, webcamSubmitText, 'ÊãçÁÖßÂπ∂Ê£ÄÊµã');
        }, 'image/jpeg', 0.9);
    });

    function performDetection(formData, loaderElement, textElement, defaultText) {
        loaderElement.style.display = 'inline-block';
        textElement.textContent = 'Ê£ÄÊµã‰∏≠...';
        const fileSubmitBtn = uploadForm.querySelector('button[type="submit"]');
        fileSubmitBtn.disabled = true;
        captureAndDetectBtn.disabled = true;


        fetch('/upload', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(faces => {
                imageCtx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
                if (uploadedImage.complete && uploadedImage.naturalWidth > 0) {
                    imageCtx.drawImage(uploadedImage, 0, 0, imageCanvas.width, imageCanvas.height);
                    drawDetectionBoxes(faces);
                } else {
                    uploadedImage.onload = () => {
                        setCanvasDimensions(uploadedImage.naturalWidth, uploadedImage.naturalHeight);
                        imageCtx.drawImage(uploadedImage, 0, 0, imageCanvas.width, imageCanvas.height);
                        drawDetectionBoxes(faces);
                    }
                }
            })
            .catch(error => {
                console.error('Ê£ÄÊµãÂ§±Ë¥•:', error);
                alert(`Ê£ÄÊµãÂ§±Ë¥•: ${error.message}`);
                imageCtx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
                if (uploadedImage.complete && uploadedImage.naturalWidth > 0) {
                    imageCtx.drawImage(uploadedImage, 0, 0, imageCanvas.width, imageCanvas.height);
                }
            })
            .finally(() => {
                loaderElement.style.display = 'none';
                textElement.textContent = defaultText;
                fileSubmitBtn.disabled = false;
                captureAndDetectBtn.disabled = !stream;
            });
    }

    function setCanvasDimensions(naturalWidth, naturalHeight) {
        imageCanvas.width = naturalWidth;
        imageCanvas.height = naturalHeight;

        uploadedImage.style.width = naturalWidth + 'px';
        uploadedImage.style.height = naturalHeight + 'px';
        imageCanvas.style.width = naturalWidth + 'px';
        imageCanvas.style.height = naturalHeight + 'px';
    }


    function drawDetectionBoxes(faces) {
        imageCtx.strokeStyle = '#ff4757';
        imageCtx.lineWidth = 3;
        imageCtx.font = 'bold 16px Arial';
        imageCtx.fillStyle = '#ff4757';

        faces.forEach((face, index) => {
            imageCtx.beginPath();
            imageCtx.rect(face.x, face.y, face.width, face.height);
            imageCtx.stroke();
        });
    }

    imageContainer.style.display = 'none';

</script>
</body>
</html>